#! /bin/bash
#
# This script deletes the trash older than one month. It deletes the oldest trash first.
#

set -e


quest()
{
  local fmt="$1"
  local query="$2"

  iquest --no-page "$fmt" "$query" \
    | sed '/^CAT_NO_ROWS_FOUND: Nothing was found matching your query$/d'
}


truncate_by_time()
{
  local upperBound="$1"

  while read -r modifyTs dataObj
  do
    if [ "$modifyTs" -ge "$upperBound" ]
    then
      break
    fi

    printf '%d %s\n' "$modifyTs" "$dataObj"
  done
}


prune_collection()
{
  local collection="$1"

  if [ 0 -eq $(quest '%s' "select count(DATA_ID) where COLL_NAME = '$collection'") ]
  then
    if irm -f -r -v "$collection"
    then
      printf 'Deleted collection %s\n' "$collection"
    fi
  else
    prune_children "$collection"
  fi
}


prune_children()
{
  local parent="$1"

  while read -r collection
  do
    prune_collection "$collection"
  done < <(quest '%s' "select COLL_NAME where COLL_PARENT_NAME = '$parent'")
}


readonly UpperBound=$(date --date '1 month ago' '+%s')

# Remove the data objects
quest '%s %s/%s' \
      "select max(DATA_MODIFY_TIME), COLL_NAME, DATA_NAME
       where COLL_NAME like '/iplant/trash/home/%'" \
  | sed 's/^0//' \
  | sort --numeric --key 1,1 \
  | truncate_by_time "$UpperBound" \
  | cut --delimiter ' ' --fields 2- \
  | xargs --no-run-if-empty --delimiter '\n' irm -f -v

# Remove the empty trash collections
while read -r parent
do
  prune_children "$parent"
done < <(quest '%s' "select COLL_NAME where COLL_PARENT_NAME = '/iplant/trash/home'")
